<div class="dashboard-container">
  <app-sidebar></app-sidebar>
  <main class="main-content">
    <div class="leave-page">
      <!-- Stats Row -->
      <section class="card stats-row">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <h4>Weekly Pattern</h4>
              <small>Weekly Pattern</small>
            </div>
            <div class="bar-row">
              <div *ngFor="let v of weeklyPattern" class="bar" [style.height.%]="Math.min(100, (v || 0) * 8)"></div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <h4>Consumed Leave Types</h4>
              <small>Consumed Leave Types</small>
            </div>
            <div class="donut-placeholder">
              <div class="donut-center">Leave<br />Types</div>
            </div>
            <ul class="consumed-list">
              <li *ngFor="let t of consumedByType">
                <span class="dot"></span>
                {{ t.name }} <strong>{{ t.value }}</strong>
              </li>
            </ul>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <h4>Monthly Stats</h4>
              <small>Monthly Stats</small>
            </div>
            <div class="bar-row">
              <div *ngFor="let m of monthlyStats" class="bar small" [style.height.%]="Math.min(100, (m || 0) * 2)">
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <header class="card-header">
          <div>
            <p class="eyebrow">Request for a Leave</p>
            <h1>Plan your time off</h1>
            <p class="subtitle">
              Submit a new leave request with a clear reason and timeline.
            </p>
          </div>
        </header>

        <form class="leave-form" [formGroup]="leaveForm" (ngSubmit)="submitRequest()">
          <div class="form-grid">
            <label>
              <span>Leave Type</span>
              <select formControlName="leaveTypeId">
                <option [ngValue]="null" disabled>Select a leave type</option>
                <option *ngFor="let option of leaveTypeOptions" [ngValue]="option.id">
                  {{ option.name }} ({{ option.code }})
                </option>
              </select>
            </label>

            <label>
              <span>Start Date</span>
              <input type="datetime-local" formControlName="startDate" />
            </label>

            <label>
              <span>End Date</span>
              <input type="datetime-local" formControlName="endDate" />
            </label>
          </div>

          <label class="reason">
            <span>Reason</span>
            <textarea rows="3" formControlName="reason" placeholder="Explain why you need the time off"></textarea>
          </label>

          <div class="leave-summary" *ngIf="selectedLeaveType || totalLeaveDays !== null">
            <p><strong>Total Days:</strong> {{ totalLeaveDays ?? "—" }}</p>
            <p>
              <strong>Default Allowed:</strong>
              {{
              selectedLeaveType
              ? (selectedLeaveType.isUnlimited ? "Unlimited" : selectedLeaveType.defaultDays)
              : "—"
              }}
            </p>
            <p>
              <strong>Remaining:</strong>
              {{
              selectedLeaveType?.isUnlimited
              ? "Unlimited"
              : remainingDays ?? (selectedLeaveType ? selectedLeaveType.defaultDays : "—")
              }}
            </p>
          </div>

          <div class="alert error" *ngIf="leaveForm.errors?.['invalidDateRange'] && leaveForm.dirty">
            End date cannot be earlier than the start date.
          </div>
          <div class="alert error" *ngIf="leaveForm.errors?.['exceedsBalance'] && leaveForm.dirty">
            Requested leave exceeds the available balance for {{ selectedLeaveType?.name }}.
          </div>

          <div class="form-actions">
            <button class="ghost" type="button" (click)="resetForm()">Reset</button>
            <button class="primary" type="submit" [disabled]="isSubmitting">
              {{ isSubmitting ? "Submitting..." : "Request Leave" }}
            </button>
          </div>
        </form>

        <div *ngIf="successMessage" class="alert success">{{ successMessage }}</div>
        <div *ngIf="errorMessage" class="alert error">{{ errorMessage }}</div>
      </section>

      <section class="card leave-types-grid">
        <header class="card-header">
          <div>
            <p class="eyebrow">Leave Types</p>
            <h2>Available Leave Types</h2>
            <p class="subtitle">
              View all available leave types and their current availability status.
            </p>
          </div>
        </header>

        <div *ngIf="isLoadingLeaveTypes" class="state">Loading leave types...</div>
        <div *ngIf="!isLoadingLeaveTypes && leaveTypes.length === 0" class="state">
          No leave types available.
        </div>

        <div *ngIf="!isLoadingLeaveTypes && leaveTypes.length > 0" class="leave-cards">
          <div *ngFor="let lt of leaveTypes; let i = index" class="leave-card">
            <div class="leave-card-top">
              <div class="leave-title">{{ lt.leaveTypeName }}</div>
              <a class="view-details" href="#">View details</a>
            </div>

            <div class="leave-donut-row">
              <div class="donut" [ngStyle]="getDonutStyle(lt, i)">
                <div class="donut-center">
                  <div class="donut-value">{{ getAvailableDays(lt) }}</div>
                  <div class="donut-label">Days Available</div>
                </div>
              </div>

              <div class="leave-summary-table">
                <div class="summary-row"><span class="meta-label">AVAILABLE</span><span class="meta-value">{{
                    getAvailableDays(lt) }}</span></div>
                <div class="summary-row"><span class="meta-label">CONSUMED</span><span class="meta-value">{{
                    getConsumedDays(lt) }}</span></div>
                <div class="summary-row"><span class="meta-label">ACCRUED SO FAR</span><span class="meta-value">{{
                    lt.accruedSoFar ?? '-' }}</span></div>
                <div class="summary-row"><span class="meta-label">ANNUAL QUOTA</span><span class="meta-value">{{
                    getAnnualQuota(lt) }}</span></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <header class="card-header">
          <div>
            <p class="eyebrow">My Requests</p>
            <h2>Track your leaves</h2>
          </div>
        </header>

        <div *ngIf="isLoadingMy" class="state">Loading your requests...</div>
        <div *ngIf="!isLoadingMy && myRequests.length === 0" class="state">
          You haven't submitted any leave requests yet.
        </div>
        <div *ngIf="!isLoadingMy && myRequests.length > 0" class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Duration</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let request of myRequests">
                <td>
                  <div class="cell-main">
                    <span class="title">{{ request.leaveTypeName }}</span>
                    <small>{{ request.reason }}</small>
                  </div>
                </td>
                <td>
                  {{ formatDate(request.startDate) }} -
                  {{ formatDate(request.endDate) }}
                </td>
                <td>
                  <span class="status" [class]="request.status.toLowerCase()">
                    {{ request.status }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card" *ngIf="canManageTeam">
        <header class="card-header">
          <div>
            <p class="eyebrow">Team</p>
            <h2>Approve or reject requests</h2>
            <p class="subtitle">
              Review every pending leave before approving. Employees are notified
              instantly after your decision.
            </p>
          </div>
        </header>

        <div *ngIf="isLoadingTeam" class="state">Loading team requests...</div>
        <div *ngIf="!isLoadingTeam && teamRequests.length === 0" class="state">
          No team leave requests awaiting your action.
        </div>
        <div *ngIf="!isLoadingTeam && teamRequests.length > 0" class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Details</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let request of teamRequests">
                <td>
                  <div class="cell-main">
                    <span class="title">{{ request.employeeName }}</span>
                    <small>{{ request.leaveTypeName }}</small>
                  </div>
                </td>
                <td>
                  <div>{{ formatDate(request.startDate) }} to {{ formatDate(request.endDate) }}</div>
                  <small>{{ request.reason }}</small>
                </td>
                <td>
                  <span class="status" [class]="request.status.toLowerCase()">
                    {{ request.status }}
                  </span>
                </td>
                <td>
                  <div class="actions">
                    <button type="button" class="ghost" (click)="approve(request)"
                      [disabled]="request.status !== 'Pending'">
                      Approve
                    </button>
                    <button type="button" class="ghost reject" (click)="reject(request)"
                      [disabled]="request.status !== 'Pending'">
                      Reject
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card" *ngIf="notifications.length > 0">
        <header class="card-header">
          <div>
            <p class="eyebrow">Notifications</p>
            <h2>Recent updates</h2>
          </div>
        </header>
        <ul class="notifications">
          <li *ngFor="let note of notifications">{{ note }}</li>
        </ul>
      </section>
    </div>
  </main>
</div>